<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Grand Element Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#eaf6ff; --accent:#5ec5ff; --accent2:#ff6a00; --muted:#1b2537; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; min-height:100vh; color:var(--fg);
      font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; overflow-x:hidden; background:#000;
    }
    /* background layer */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:#000 center/cover no-repeat fixed;
      background-image: var(--bg-img, none);
    }
    .wrap{ margin:auto; width:min(980px,94vw); padding:28px; text-align:center; }
    .logo{ width:min(260px,60vw); height:auto; border-radius:50%;
           filter: drop-shadow(0 0 24px rgba(94,197,255,.55));
           margin:4px 0 12px; }
    h1{margin:8px 0 2px; font-weight:700; letter-spacing:.3px}
    .subtitle{opacity:.9;margin:2px 0 16px}
    .titlebar{ margin: 8px 0 14px; font-weight:700; font-size:1.05rem; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:16px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
    }

    .controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:8px 0 8px}
    .btn{ appearance:none; border:0; padding:10px 14px; border-radius:10px;
          background:#141d2b; color:#eaf6ff; cursor:pointer; font-weight:600;
          border:1px solid rgba(255,255,255,.12); }
    .btn:hover{background:#1b2537}
    .btn.primary{ background:var(--accent); color:#03111b; border-color:transparent; }
    .btn.primary[aria-pressed="true"]{ filter:brightness(1.05); box-shadow:0 0 0 2px rgba(94,197,255,.35) inset; }
    .btn.alt{ background:var(--muted); }
    .btn.alt[aria-pressed="true"]{ background:#26324a; box-shadow:0 0 0 2px rgba(255,255,255,.15) inset; }

    audio{ width:100%; margin-top:8px; transform: scale(1.25); transform-origin: center top; }
    a.button{ display:inline-block; padding:10px 18px; margin-top:14px; background:var(--accent2);
              color:#fff; text-decoration:none; border-radius:10px; font-weight:700;
              box-shadow: 0 6px 16px rgba(255,106,0,.25); }
    a.button:hover{ filter:brightness(1.05) }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Make sure /img/logo.png exists -->
    <img class="logo" src="img/logo.png" alt="Grand Element" />

    <h1>Grand Element Radio</h1>
    <p class="subtitle">Music created to help set your soul free. Enjoy!!</p>

    <!-- Nice title (Album • Track) -->
    <div class="titlebar" id="titlebar"></div>

    <div class="panel">
      <div class="controls">
        <button class="btn alt" id="orderBtn" aria-pressed="false" title="Album order">Album order</button>
        <button class="btn primary" id="shuffleBtn" aria-pressed="true" title="Shuffle">Shuffle</button>
        <button class="btn" id="prevBtn" title="Previous (Left Arrow)">Prev</button>
        <button class="btn primary" id="nextBtn" title="Next (Right Arrow)">Next</button>
      </div>
      <audio id="player" controls preload="none"></audio>
    </div>

    <a class="button" href="https://grandelement.bandcamp.com" target="_blank" rel="noopener">Buy on Bandcamp</a>
  </div>

  <script>
    // --- Background: new random each refresh, cache-bust, simple fallback ---
    (function(){
      fetch('backgrounds.json', {cache:'no-store'})
        .then(r => r.ok ? r.json() : [])
        .then(list => {
          if (!Array.isArray(list) || !list.length) return;
          const last = sessionStorage.getItem('lastBg');
          let pick = list[Math.floor(Math.random() * list.length)];
          if (list.length > 1 && pick === last) {
            const i = list.indexOf(pick);
            pick = list[(i + 1) % list.length];
          }
          const url = pick + '?v=' + Date.now();
          const img = new Image();
          img.onload  = () => { document.body.style.setProperty('--bg-img', 'url("' + url + '")'); sessionStorage.setItem('lastBg', pick); };
          img.onerror = () => { document.body.style.setProperty('--bg-img', 'url("' + pick + '")'); };
          img.src = pick;
        })
        .catch(()=>{});
    })();

    // --- Player ---
    const audio = document.getElementById('player');
    const titlebar = document.getElementById('titlebar');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const orderBtn = document.getElementById('orderBtn');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');

    let items=[], library=[], titleMap=new Map(), order=[], i=0, shuffleOn=true;

    function prettyTitle(p){
      return p.split('/').pop()
              .replace(/\.[^.]+$/,'')
              .replace(/[_-]+/g,' ')   // restore spaces
              .replace(/\s+/g,' ')
              .trim();
    }
    function displayTitle(src){
      const t = titleMap.get(src) || prettyTitle(src);
      const parts = t.split(' - ');
      if (parts.length >= 2) {
        return { album: parts[0].trim(), track: parts.slice(1).join(' - ').trim() };
      }
      return { album: '', track: t };
    }
    function updateTitle(src){
      const t = displayTitle(src);
      titlebar.textContent = t.album ? (t.album + ' • ' + t.track) : t.track;
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let k=a.length-1;k>0;k--){const j=(Math.random()*(k+1))|0; [a[k],a[j]]=[a[j],a[k]]}
      return a;
    }
    function setToggleUI(){
      shuffleBtn.setAttribute('aria-pressed', String(shuffleOn));
      orderBtn.setAttribute('aria-pressed', String(!shuffleOn));
    }
    function setOrder(){
      const current = audio.src ? library.find(p => audio.src.includes(p)) : null;
      order = shuffleOn ? shuffle(library) : library.slice();
      if (current){ const keep = order.indexOf(current); i = keep >= 0 ? keep : 0; } else { i = 0; }
      setToggleUI();
    }
    function loadTrack(idx){
      if (!order.length) return;
      i = (idx + order.length) % order.length;
      const src = order[i];
      audio.src = src + '?v=' + Date.now(); // cache-bust so scrubbing works across updates
      updateTitle(src);

      // Media Session (lock screen controls)
      if ('mediaSession' in navigator) {
        const t = displayTitle(src);
        navigator.mediaSession.metadata = new MediaMetadata({
          title: t.track || 'Grand Element',
          artist: 'Grand Element',
          album: t.album || 'Grand Element Radio'
        });
        try{navigator.mediaSession.setActionHandler('previoustrack',()=>loadTrack(i-1))}catch(e){}
        try{navigator.mediaSession.setActionHandler('nexttrack',()=>loadTrack(i+1))}catch(e){}
        try{navigator.mediaSession.setActionHandler('play',()=>audio.play())}catch(e){}
        try{navigator.mediaSession.setActionHandler('pause',()=>audio.pause())}catch(e){}
      }

      // Try to autoplay silently; if blocked, user uses native play—no overlay/prompt shown
      audio.play().catch(()=>{});
    }

    // Controls
    nextBtn.addEventListener('click', ()=> loadTrack(i+1));
    prevBtn.addEventListener('click', ()=> loadTrack(i-1));
    shuffleBtn.addEventListener('click', ()=>{ shuffleOn = true;  setOrder(); });
    orderBtn .addEventListener('click', ()=>{ shuffleOn = false; setOrder(); });

    // Keyboard next/prev
    window.addEventListener('keydown', e => {
      if(e.key==='ArrowRight'){ e.preventDefault(); loadTrack(i+1); }
      if(e.key==='ArrowLeft'){  e.preventDefault(); loadTrack(i-1); }
    });

    // Boot
    (async function boot(){
      const r = await fetch('playlist.json',{cache:'no-store'});
      if(!r.ok) throw new Error('playlist.json not found');
      const raw = await r.json();
      items    = raw.map(x => typeof x==='string' ? ({src:x, title:null}) : x);
      library  = items.map(o => o.src);
      titleMap = new Map(items.map(o => [o.src, o.title]));
      setOrder();
      loadTrack(i);

      // Also try to start on first interaction (helps Safari/iOS)
      window.addEventListener('pointerdown', ()=> audio.play().catch(()=>{}), {once:true});
      window.addEventListener('keydown',     ()=> audio.play().catch(()=>{}), {once:true});
    })().catch(err=>{
      titlebar.textContent = 'Error: '+err.message;
    });
  </script>
</body>
</html>
