<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Grand Element Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#eaf6ff; --accent:#5ec5ff; --accent2:#ff6a00; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; min-height:100vh; color:var(--fg);
      font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; overflow-x:hidden; background:#000;
    }
    /* wallpaper layer */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:#000 center/cover no-repeat fixed;
      background-image: var(--bg-img, none);
      transition: opacity .4s ease;
      opacity: 1;
    }
    .wrap{ margin:auto; width:min(980px,94vw); padding:28px; text-align:center; }
    .logo{ width:min(260px,60vw); height:auto; border-radius:50%;
           filter: drop-shadow(0 0 24px rgba(94,197,255,.55)); margin:4px 0 12px; }
    h1{margin:8px 0 2px; font-weight:700; letter-spacing:.3px}
    .subtitle{opacity:.9;margin:2px 0 16px}
    .titlebar{ margin: 8px 0 14px; font-weight:700; font-size:1.05rem; }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:16px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
    }
    .controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:8px 0 8px}
    .btn{ appearance:none; border:0; padding:10px 14px; border-radius:10px; background:#141d2b; color:#eaf6ff;
          cursor:pointer; font-weight:600; border:1px solid rgba(255,255,255,.12); }
    .btn:hover{background:#1b2537}
    .btn.accent{ background:var(--accent); color:#03111b; border-color:transparent; }
    .btn.accent:hover{ filter:brightness(1.05) }
    audio{ width:100%; margin-top:8px; transform: scale(1.25); transform-origin: center top; }
    a.button{ display:inline-block; padding:10px 18px; margin-top:14px; background:var(--accent2); color:#fff; text-decoration:none; border-radius:10px; font-weight:700; box-shadow: 0 6px 16px rgba(255,106,0,.25); }
    a.button:hover{ filter:brightness(1.05) }

    /* One-tap overlay when autoplay is blocked */
    .overlay{
      position: fixed; inset:0; background: rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index: 10;
    }
    .overlay .bigplay{
      font-size:1.2rem; padding:14px 20px; border-radius:12px;
      background:var(--accent); color:#03111b; border:0; cursor:pointer; font-weight:800;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Make sure /img/logo.png exists -->
    <img class="logo" src="img/logo.png" alt="Grand Element" />

    <h1>Grand Element Radio</h1>
    <p class="subtitle">Music created to help set your soul free. Enjoy!!</p>

    <!-- Nicely formatted title (Album • Track) -->
    <div class="titlebar" id="titlebar"></div>

    <div class="panel">
      <div class="controls">
        <button class="btn" id="prevBtn" title="Previous (Left Arrow)">Prev</button>
        <button class="btn accent" id="nextBtn" title="Next (Right Arrow)">Next</button>
        <button class="btn" id="shuffleBtn" title="Toggle Shuffle">Shuffle: <span id="shufState">On</span></button>
      </div>
      <audio id="player" controls preload="none"></audio>
    </div>

    <a class="button" href="https://grandelement.bandcamp.com" target="_blank" rel="noopener">Buy on Bandcamp</a>
  </div>

  <!-- Autoplay unlock overlay -->
  <div class="overlay" id="overlay">
    <button class="bigplay" id="bigPlay">▶ Play Grand Element Radio</button>
  </div>

  <script>
    // --- Robust background picker on each refresh (preload + fallback, no black screen) ---
    (function(){
      fetch('backgrounds.json', {cache:'no-store'})
        .then(r => r.ok ? r.json() : [])
        .then(list => {
          if (!Array.isArray(list) || !list.length) return;
          const last = sessionStorage.getItem('lastBg');
          let pick = list[Math.floor(Math.random() * list.length)];
          if (list.length > 1 && pick === last) {
            const i = list.indexOf(pick);
            pick = list[(i + 1) % list.length];
          }
          // preload image first, then apply. Cache-bust to avoid stale frames.
          const url = pick + '?v=' + Date.now();
          const img = new Image();
          img.onload = () => {
            document.body.style.setProperty('--bg-img', 'url("' + url + '")');
            sessionStorage.setItem('lastBg', pick);
          };
          img.onerror = () => {
            // fallback: first valid in list without preload (best effort)
            const fallback = list.find(x => x !== pick) || pick;
            document.body.style.setProperty('--bg-img', 'url("' + fallback + '")');
          };
          img.src = pick;
        })
        .catch(()=>{});
    })();

    // --- Player ---
    const audio = document.getElementById('player');
    const titlebar = document.getElementById('titlebar');
    const shufBtn = document.getElementById('shuffleBtn');
    const shufStateEl = document.getElementById('shufState');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');

    let items=[], library=[], titleMap=new Map(), order=[], i=0, shuffleOn=true;

    function prettyTitle(p){
      return p.split('/').pop()
              .replace(/\.[^.]+$/,'')
              .replace(/[_-]+/g,' ')
              .replace(/\s+/g,' ')
              .trim();
    }
    function displayTitle(src){
      const t = titleMap.get(src) || prettyTitle(src);
      // If title is "Album - Track", format nicely
      const parts = t.split(' - ');
      if (parts.length >= 2) {
        return { album: parts[0].trim(), track: parts.slice(1).join(' - ').trim() };
      }
      return { album: '', track: t };
    }
    function updateTitle(src){
      const t = displayTitle(src);
      titlebar.textContent = t.album ? (t.album + ' • ' + t.track) : t.track;
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let k=a.length-1;k>0;k--){const j=(Math.random()*(k+1))|0; [a[k],a[j]]=[a[j],a[k]]}
      return a;
    }
    function setOrder(){
      const current = audio.src ? library.find(p => audio.src.includes(p)) : null;
      order = shuffleOn ? shuffle(library) : library.slice();
      if (current){ const keep = order.indexOf(current); i = keep >= 0 ? keep : 0; } else { i = 0; }
    }
    function loadTrack(idx){
      if (!order.length) return;
      i = (idx + order.length) % order.length;
      const src = order[i];
      audio.src = src + '?v=' + Date.now(); // bust caches
      updateTitle(src);
      // Media Session metadata for lock-screen controls
      if ('mediaSession' in navigator) {
        const t = displayTitle(src);
        navigator.mediaSession.metadata = new MediaMetadata({
          title: t.track || 'Grand Element',
          artist: 'Grand Element',
          album: t.album || 'Grand Element Radio'
        });
        try{navigator.mediaSession.setActionHandler('previoustrack',()=>loadTrack(i-1))}catch(e){}
        try{navigator.mediaSession.setActionHandler('nexttrack',()=>loadTrack(i+1))}catch(e){}
        try{navigator.mediaSession.setActionHandler('play',()=>audio.play())}catch(e){}
        try{navigator.mediaSession.setActionHandler('pause',()=>audio.pause())}catch(e){}
      }
      audio.play().catch(()=>{}); // attempt autoplay; if blocked, overlay will handle
    }

    // Attempt to autoplay on load; if blocked, show overlay
    const overlay = document.getElementById('overlay');
    const bigPlay = document.getElementById('bigPlay');
    function tryAutoplay(){
      audio.play().then(()=>{ overlay.style.display='none'; }).catch(()=>{
        overlay.style.display='flex';
      });
    }
    bigPlay.addEventListener('click', ()=>{ overlay.style.display='none'; audio.play().catch(()=>{}); });

    audio.addEventListener('ended', ()=> loadTrack(i+1));
    nextBtn.addEventListener('click', ()=> loadTrack(i+1));
    prevBtn.addEventListener('click', ()=> loadTrack(i-1));
    shufBtn.addEventListener('click', ()=>{ shuffleOn = !shuffleOn; shufStateEl.textContent = shuffleOn ? 'On' : 'Off'; setOrder(); });

    // Boot
    (async function boot(){
      const r = await fetch('playlist.json',{cache:'no-store'});
      if(!r.ok) throw new Error('playlist.json not found');
      const raw = await r.json();
      items = raw.map(x => typeof x==='string' ? ({src:x, title:null}) : x);
      library = items.map(o => o.src);
      titleMap = new Map(items.map(o => [o.src, o.title]));
      setOrder();
      loadTrack(i);
      // Try autoplay now and also on first user interaction
      tryAutoplay();
      window.addEventListener('pointerdown', tryAutoplay, {once:true});
      window.addEventListener('keydown', tryAutoplay, {once:true});
    })().catch(err=>{
      overlay.style.display = 'none';
      titlebar.textContent = 'Error: '+err.message;
    });
  </script>
</body>
</html>
